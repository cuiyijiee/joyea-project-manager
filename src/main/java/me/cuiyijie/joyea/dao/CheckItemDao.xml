<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="me.cuiyijie.joyea.dao.CheckItemDao">
    <resultMap id="BaseResultMap" type="me.cuiyijie.joyea.model.CheckItem">

        <id property="fid" column="FID"/>
        <id property="taskId" column="CFTASKID"/>
        <id property="checkModeId" column="CFCHECKMODELID"/>
        <id property="typeId" column="CFTYPEID"/>
        <id property="seq" column="CFSEQ"/>
        <id property="keyItem" column="CFKEYITEM"/>
        <id property="checkStandard" column="CFCHECKSTANDARD"/>
        <id property="needText" column="CFNEEDTEXT"/>
        <id property="needAttachment" column="CFNEEDATTACHMENT"/>
        <id property="needPicture" column="CFNEEDPICTURE"/>
        <id property="needVideo" column="CFNEEDVIDEO"/>
        <id property="typeName" column="CFTYPENAME"/>
        <id property="checkMethodId" column="ZYFFID"/>
        <id property="checkMethod" column="ZYFF"/>

    </resultMap>

    <select id="selectWithPage" resultMap="BaseResultMap">
        SELECT t.FID,
        t.CFTASKID,
        t.CFCHECKMODELID,
        t.CFTYPEID,
        t.CFSEQ,
        t.CFKEYITEM,
        t.CFCHECKSTANDARD,
        t.CFNEEDTEXT,
        t.CFNEEDATTACHMENT,
        t.CFNEEDPICTURE,
        t.CFNEEDVIDEO,
        t.CFTYPENAME,
        t.ZYFFID,
        t.ZYFF
        <choose>
            <when test="!item.finished">
                FROM (
                select a.*,b.CFCheckType from VW_SYX_ZLGL_DJX a
                left join ct_pre_qualitycheckresult b on b.CFCheckEntryID = a.fid where b.fid is null
                union all
                select a.*,b.CFCheckType from VW_SYX_ZLGL_DJX a
                left join ct_pre_qualitycheckresult b on b.CFCheckEntryID = a.fid
                WHERE b.CFCheckResult = 0 and b.CFCheckType = 2
                ) t
            </when>
            <otherwise>
                FROM VW_SYX_ZLGL_DJX t
            </otherwise>
        </choose>
        WHERE (t.CFTASKID = #{item.taskId})
        <if test="item.checkStandard != null and item.checkStandard != ''">
            AND t.CFCHECKSTANDARD like CONCAT(CONCAT('%',#{item.checkStandard}),'%')
        </if>
        <if test="item.keyItem != null and item.keyItem != -1">
            AND t.CFKEYITEM = #{item.keyItem}
        </if>
        ORDER BY t.CFSEQ ASC
    </select>

</mapper>